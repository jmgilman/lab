name: VyOS Integration Tests

on:
  push:
    branches: [master]
    paths:
      - 'infrastructure/network/vyos/**'
  pull_request:
    paths:
      - 'infrastructure/network/vyos/**'
  workflow_dispatch:

concurrency:
  group: vyos-test-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check scripts are executable
        run: |
          for script in infrastructure/network/vyos/scripts/*.sh infrastructure/network/vyos/tests/*.sh; do
            if [[ -f "${script}" && ! -x "${script}" ]]; then
              echo "ERROR: Script not executable: ${script}"
              exit 1
            fi
            echo "OK: ${script}"
          done

      - name: Validate topology file
        run: |
          python3 -c "import yaml; yaml.safe_load(open('infrastructure/network/vyos/tests/topology.clab.yml'))"
          echo "Topology file is valid YAML"

  build-container:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full squashfs-tools-ng

      - name: Download VyOS ISO
        run: |
          # Extract URL and checksum from images.yaml
          URL=$(grep -A5 'name: vyos-stream' images/images.yaml | grep 'url:' | awk '{print $2}')
          EXPECTED=$(grep -A5 'name: vyos-stream' images/images.yaml | grep 'checksum:' | awk '{print $2}' | cut -d: -f2)

          echo "Downloading VyOS ISO from: ${URL}"
          curl -L -o /tmp/vyos.iso "${URL}"

          echo "Verifying checksum..."
          ACTUAL=$(sha256sum /tmp/vyos.iso | awk '{print $1}')

          if [[ "${EXPECTED}" != "${ACTUAL}" ]]; then
            echo "ERROR: Checksum mismatch"
            echo "Expected: ${EXPECTED}"
            echo "Actual: ${ACTUAL}"
            exit 1
          fi
          echo "Checksum verified"

      - name: Build container image from ISO
        run: |
          infrastructure/network/vyos/scripts/iso-to-container.sh /tmp/vyos.iso vyos-gateway:test

      - name: Save container image
        run: |
          docker save vyos-gateway:test -o /tmp/vyos-gateway-container.tar
          ls -lah /tmp/vyos-gateway-container.tar

      - name: Upload container image artifact
        uses: actions/upload-artifact@v4
        with:
          name: vyos-container-image
          path: /tmp/vyos-gateway-container.tar
          retention-days: 1

  integration-test:
    needs: build-container
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download container image artifact
        uses: actions/download-artifact@v4
        with:
          name: vyos-container-image
          path: /tmp

      - name: Load container image
        run: |
          docker load -i /tmp/vyos-gateway-container.tar
          docker images vyos-gateway:test

      - name: Install Containerlab
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"
          containerlab version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: infrastructure/network/vyos/tests/requirements.txt

      - name: Install test dependencies
        run: |
          pip install -r infrastructure/network/vyos/tests/requirements.txt

      - name: Generate test config.boot
        run: |
          ssh-keygen -t ed25519 -f /tmp/vyos-test-key -N "" -C "vyos-ci"
          infrastructure/network/vyos/tests/render-config-boot.sh "$(cat /tmp/vyos-test-key.pub)"

      - name: Deploy Containerlab topology
        run: |
          cd infrastructure/network/vyos/tests
          sudo containerlab deploy -t topology.clab.yml --reconfigure
        timeout-minutes: 10

      - name: Initialize VyOS config
        run: |
          CONTAINER="clab-vyos-gateway-test-gateway"
          sudo docker exec "${CONTAINER}" sh -c "modprobe br_netfilter || true"
          sudo docker exec "${CONTAINER}" sh -c "timeout 60 python3 /usr/libexec/vyos/vyos-boot-config-loader.py /opt/vyatta/etc/config/config.boot || true"

      - name: Wait for VyOS boot
        run: |
          echo "Waiting for VyOS to boot..."
          CONTAINER="clab-vyos-gateway-test-gateway"

          # Wait for container to be running
          for i in {1..30}; do
            if docker ps --filter "name=${CONTAINER}" --filter "status=running" | grep -q "${CONTAINER}"; then
              echo "Container is running"
              break
            fi
            echo "Waiting for container... ($i/30)"
            sleep 3
          done

          # Wait for systemd to be ready
          for i in {1..60}; do
            if docker exec "${CONTAINER}" systemctl is-system-running --quiet 2>/dev/null; then
              echo "VyOS systemd is running"
              break
            fi
            echo "Waiting for systemd... ($i/60)"
            sleep 5
          done

          # Additional settle time for all services
          echo "Waiting for services to stabilize..."
          sleep 30

          # Check VyOS status
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show version || true

      - name: Acquire DHCP lease for test client
        run: |
          echo "Triggering DHCP acquisition on dhcp-client..."
          DHCP_CLIENT="clab-vyos-gateway-test-dhcp-client"

          # Run udhcpc to acquire a lease from the VyOS gateway
          docker exec "${DHCP_CLIENT}" udhcpc -i eth1.10 -f -q -t 10 -T 3

          # Verify the lease was acquired
          echo "DHCP client network configuration:"
          docker exec "${DHCP_CLIENT}" ip addr show eth1.10
          docker exec "${DHCP_CLIENT}" ip route show

      - name: Run integration tests
        run: |
          cd infrastructure/network/vyos/tests
          pytest -v --tb=short -x

      - name: Collect logs on failure
        if: failure()
        run: |
          GATEWAY="clab-vyos-gateway-test-gateway"

          echo "=== Running containers ==="
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep vyos-gateway-test || true

          echo ""
          echo "=== Gateway container logs ==="
          docker logs "${GATEWAY}" 2>&1 | tail -100 || true

          echo ""
          echo "=== VyOS configuration ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show configuration 2>&1 || true

          echo ""
          echo "=== VyOS interfaces ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show interfaces 2>&1 || true

          echo ""
          echo "=== VyOS routing table ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show ip route 2>&1 || true

          echo ""
          echo "=== VyOS NAT rules ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show nat source rules 2>&1 || true

          echo ""
          echo "=== VyOS firewall ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show firewall 2>&1 || true

          echo ""
          echo "=== DHCP client status ==="
          docker exec clab-vyos-gateway-test-dhcp-client ip addr show eth1.10 2>&1 || true
          docker exec clab-vyos-gateway-test-dhcp-client ip route show 2>&1 || true

          echo ""
          echo "=== mgmt-client connectivity test ==="
          docker exec clab-vyos-gateway-test-mgmt-client ping -c 1 10.10.10.1 2>&1 || true

      - name: Cleanup
        if: always()
        run: |
          cd infrastructure/network/vyos/tests
          sudo containerlab destroy -t topology.clab.yml --cleanup || true
