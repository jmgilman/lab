name: VyOS Integration Tests

on:
  push:
    branches: [master]
    paths:
      - 'infrastructure/network/vyos/**'
  pull_request:
    paths:
      - 'infrastructure/network/vyos/**'
  workflow_dispatch:

concurrency:
  group: vyos-test-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check scripts are executable
        run: |
          for script in infrastructure/network/vyos/scripts/*.sh infrastructure/network/vyos/tests/*.sh; do
            if [[ -f "${script}" && ! -x "${script}" ]]; then
              echo "ERROR: Script not executable: ${script}"
              exit 1
            fi
            echo "OK: ${script}"
          done

      - name: Validate topology file
        run: |
          python3 -c "import yaml; yaml.safe_load(open('infrastructure/network/vyos/tests/topology.clab.yml'))"
          echo "Topology file is valid YAML"

  build-container:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full squashfs-tools-ng

      - name: Download VyOS ISO
        run: |
          # Extract URL and checksum from images.yaml
          URL=$(grep -A5 'name: vyos-stream' images/images.yaml | grep 'url:' | awk '{print $2}')
          EXPECTED=$(grep -A5 'name: vyos-stream' images/images.yaml | grep 'checksum:' | awk '{print $2}' | cut -d: -f2)

          echo "Downloading VyOS ISO from: ${URL}"
          curl -L -o /tmp/vyos.iso "${URL}"

          echo "Verifying checksum..."
          ACTUAL=$(sha256sum /tmp/vyos.iso | awk '{print $1}')

          if [[ "${EXPECTED}" != "${ACTUAL}" ]]; then
            echo "ERROR: Checksum mismatch"
            echo "Expected: ${EXPECTED}"
            echo "Actual: ${ACTUAL}"
            exit 1
          fi
          echo "Checksum verified"

      - name: Build container image from ISO
        run: |
          infrastructure/network/vyos/scripts/iso-to-container.sh /tmp/vyos.iso vyos-gateway:test

      - name: Save container image
        run: |
          docker save vyos-gateway:test -o /tmp/vyos-gateway-container.tar
          ls -lah /tmp/vyos-gateway-container.tar

      - name: Upload container image artifact
        uses: actions/upload-artifact@v4
        with:
          name: vyos-container-image
          path: /tmp/vyos-gateway-container.tar
          retention-days: 1

  integration-test:
    needs: build-container
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Download container image artifact
        uses: actions/download-artifact@v4
        with:
          name: vyos-container-image
          path: /tmp

      - name: Load container image
        run: |
          docker load -i /tmp/vyos-gateway-container.tar
          docker images vyos-gateway:test

      - name: Install Containerlab
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)"
          containerlab version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: infrastructure/network/vyos/tests/requirements.txt

      - name: Install test dependencies
        run: |
          pip install -r infrastructure/network/vyos/tests/requirements.txt

      - name: Generate test config.boot
        run: |
          ssh-keygen -t ed25519 -f /tmp/vyos-test-key -N "" -C "vyos-ci"
          infrastructure/network/vyos/tests/render-config-boot.sh "$(cat /tmp/vyos-test-key.pub)"

      - name: Deploy Containerlab topology
        run: |
          cd infrastructure/network/vyos/tests
          sudo containerlab deploy -t topology.clab.yml --reconfigure
        timeout-minutes: 5

      - name: Wait for VyOS to be ready
        run: |
          CONTAINER="clab-vyos-gateway-test-gateway"

          echo "Waiting for container to be running..."
          for i in {1..30}; do
            if docker ps --filter "name=${CONTAINER}" --filter "status=running" | grep -q "${CONTAINER}"; then
              echo "Container is running"
              break
            fi
            echo "Waiting for container... ($i/30)"
            sleep 2
          done

          echo "Loading kernel modules..."
          sudo docker exec "${CONTAINER}" modprobe br_netfilter || true

          echo "Waiting for VyOS config to be applied..."
          # VyOS loads config automatically via vyos-router.service
          # The "systemd running" state happens before config is applied
          # Config migration takes ~100 seconds in container environments
          # The message appears in docker logs (container stdout), not dmesg
          for i in {1..90}; do
            # Check for config migration completion in container logs
            if docker logs "${CONTAINER}" 2>&1 | grep -q "migrate.*configure"; then
              echo "VyOS config migration detected"
              # Wait for services to start
              sleep 15
              break
            fi
            echo "Waiting for VyOS config... ($i/90)"
            sleep 2
          done

          echo "Verifying configuration loaded..."
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show configuration commands | head -10

          # Check if kea-dhcp4 process is running
          echo "=== DHCP server process check ==="
          docker exec "${CONTAINER}" pgrep -a kea-dhcp4 || echo "WARNING: kea-dhcp4 process not found"

          # Check DHCP server status
          echo "=== DHCP server status ==="
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show dhcp server leases 2>&1 || true
        timeout-minutes: 5

      - name: Verify VyOS interfaces
        run: |
          CONTAINER="clab-vyos-gateway-test-gateway"

          echo "=== VyOS Version ==="
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show version

          echo ""
          echo "=== Configured Interfaces ==="
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show interfaces

          echo ""
          echo "=== DHCP Server Status ==="
          docker exec "${CONTAINER}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show dhcp server leases || echo "No leases yet"
        timeout-minutes: 2

      - name: Acquire DHCP lease for test client
        run: |
          GATEWAY="clab-vyos-gateway-test-gateway"
          DHCP_CLIENT="clab-vyos-gateway-test-dhcp-client"
          TRUNK="clab-vyos-gateway-test-trunk-switch"

          # Install tcpdump on gateway and client for diagnostics
          docker exec "${GATEWAY}" apt-get update -qq && docker exec "${GATEWAY}" apt-get install -y -qq tcpdump || true
          docker exec "${DHCP_CLIENT}" apk add --no-cache tcpdump || true

          # Debug: Show trunk-switch bridge state
          echo "=== Trunk switch bridge state ==="
          docker exec "${TRUNK}" ip link show br0 || true
          docker exec "${TRUNK}" bridge link show || true

          # Show gateway VLAN interfaces before capture
          echo "=== Gateway VLAN interfaces ==="
          docker exec "${GATEWAY}" ip addr show eth5.10 || echo "eth5.10 NOT found!"

          # Start tcpdump in background to capture on eth5.10 (VLAN subinterface)
          echo "Starting traffic capture on gateway eth5.10..."
          docker exec -d "${GATEWAY}" timeout 45 tcpdump -i eth5.10 -n -e -w /tmp/eth5.10.pcap 2>/dev/null || true

          # Also capture on eth5 for raw traffic
          echo "Starting traffic capture on gateway eth5..."
          docker exec -d "${GATEWAY}" timeout 45 tcpdump -i eth5 -n -e -w /tmp/eth5.pcap 2>/dev/null || true

          # Also capture on dhcp-client to verify packets are leaving
          echo "Starting traffic capture on dhcp-client eth1..."
          docker exec -d "${DHCP_CLIENT}" timeout 45 tcpdump -i eth1 -n -e -w /tmp/client.pcap 2>/dev/null || true

          sleep 1

          echo "Triggering DHCP acquisition on dhcp-client..."
          # Use timeout to prevent hanging; -n = exit after lease obtained or max retries
          timeout 60 docker exec "${DHCP_CLIENT}" udhcpc -i eth1.10 -n -t 10 -T 3 || {
            echo "DHCP acquisition failed or timed out"

            echo "=== DHCP client interface state ==="
            docker exec "${DHCP_CLIENT}" ip addr show eth1.10
            docker exec "${DHCP_CLIENT}" ip addr show eth1

            echo "=== Client-side packet capture (eth1) ==="
            sleep 2
            docker exec "${DHCP_CLIENT}" tcpdump -r /tmp/client.pcap -n -e 2>/dev/null | head -30 || echo "No packets captured on client"

            echo "=== Gateway eth5 packet capture (raw with VLAN tags) ==="
            docker exec "${GATEWAY}" tcpdump -r /tmp/eth5.pcap -n -e 2>/dev/null | head -20 || echo "No packets captured on eth5"

            echo "=== Gateway eth5.10 packet capture (VLAN subinterface) ==="
            docker exec "${GATEWAY}" tcpdump -r /tmp/eth5.10.pcap -n -e 2>/dev/null | head -20 || echo "No packets captured on eth5.10"

            echo "=== Check if mgmt-client can reach gateway (VLAN 10 works?) ==="
            docker exec clab-vyos-gateway-test-mgmt-client ping -c 1 -W 2 10.10.10.1 || echo "VLAN 10 connectivity FAILED"

            echo "=== Kea DHCP4 process status ==="
            docker exec "${GATEWAY}" pgrep -a kea-dhcp4 || echo "kea-dhcp4 NOT running!"

            echo "=== Gateway VLAN interfaces ==="
            docker exec "${GATEWAY}" ip addr show eth5.10 || echo "eth5.10 NOT found!"
            docker exec "${GATEWAY}" ip link show type vlan || echo "No VLAN interfaces"

            echo "=== Kea DHCP4 config ==="
            docker exec "${GATEWAY}" cat /var/run/kea/kea-dhcp4.conf 2>/dev/null || echo "Kea config not found"

            echo "=== VyOS DHCP server status ==="
            docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show dhcp server leases 2>&1 || true

            exit 1
          }

          echo "DHCP client network configuration:"
          docker exec "${DHCP_CLIENT}" ip addr show eth1.10
          docker exec "${DHCP_CLIENT}" ip route show
        timeout-minutes: 2

      - name: Run integration tests
        run: |
          cd infrastructure/network/vyos/tests
          pytest -v --tb=short -x
        timeout-minutes: 5

      - name: Collect logs on failure
        if: failure()
        run: |
          GATEWAY="clab-vyos-gateway-test-gateway"

          echo "=== Running containers ==="
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep vyos-gateway-test || true

          echo ""
          echo "=== Gateway container logs ==="
          docker logs "${GATEWAY}" 2>&1 | tail -100 || true

          echo ""
          echo "=== VyOS configuration ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show configuration 2>&1 || true

          echo ""
          echo "=== VyOS interfaces ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show interfaces 2>&1 || true

          echo ""
          echo "=== VyOS routing table ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show ip route 2>&1 || true

          echo ""
          echo "=== VyOS NAT rules ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show nat source rules 2>&1 || true

          echo ""
          echo "=== VyOS firewall ==="
          docker exec "${GATEWAY}" /opt/vyatta/bin/vyatta-op-cmd-wrapper show firewall 2>&1 || true

          echo ""
          echo "=== DHCP client status ==="
          docker exec clab-vyos-gateway-test-dhcp-client ip addr show eth1.10 2>&1 || true
          docker exec clab-vyos-gateway-test-dhcp-client ip route show 2>&1 || true

          echo ""
          echo "=== mgmt-client connectivity test ==="
          docker exec clab-vyos-gateway-test-mgmt-client ping -c 1 10.10.10.1 2>&1 || true

      - name: Cleanup
        if: always()
        run: |
          cd infrastructure/network/vyos/tests
          sudo containerlab destroy -t topology.clab.yml --cleanup || true
